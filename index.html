<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Myanmar 2D Lottery - Realtime (Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v8 (namespaced, simpler for this single-file example) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    .lottery-bg { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .bet-card{ transition: all .2s ease; border:2px solid transparent; }
    .bet-card:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,.1); }
  </style>
</head>
<body class="lottery-bg min-h-screen">

<!-- NOTE: UI mostly re-uses your original structure. -->
<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white text-center">
      <div class="text-4xl mb-2">ğŸ°</div>
      <h1 class="text-2xl font-bold mb-1">Myanmar 2D Lottery</h1>
      <p class="opacity-90">á€™á€¼á€”á€ºá€™á€¬ á‚á€œá€¯á€¶á€¸ á€‘á€® â€” Realtime</p>
    </div>

    <div class="p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">ğŸ” á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“± á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</label>
          <input type="tel" id="loginPhone" placeholder="09xxxxxxxxx" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”‘ á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º</label>
          <input type="password" id="loginPassword" placeholder="á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º á€‘á€Šá€·á€ºá€•á€«" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
        </div>
        <button id="loginBtn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 rounded-lg">ğŸš€ á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º</button>
      </div>

      <div class="mt-6 bg-yellow-50 rounded-lg p-4">
        <h3 class="text-sm font-bold text-yellow-800 mb-2">ğŸ¯ á€…á€™á€ºá€¸á€á€¯á€¶á€¸á€›á€”á€º á€¡á€€á€±á€¬á€„á€·á€ºá€™á€»á€¬á€¸</h3>
        <div class="text-xs text-yellow-700 space-y-1">
          <p><strong>User:</strong> 09123456789 / password: 123456</p>
          <p><strong>Admin:</strong> 09750397287 / password: admin123</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="container mx-auto px-4 py-8 hidden">
  <!-- Header -->
  <div class="bg-white rounded-2xl shadow-2xl mb-8 overflow-hidden">
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="bg-white bg-opacity-20 rounded-full p-2"><span class="text-2xl">ğŸ‘¤</span></div>
          <div class="text-white">
            <div class="font-bold text-lg" id="userDisplayName">Loading...</div>
            <div class="text-sm opacity-90" id="userDisplayPhone">Loading...</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-white text-right">
            <div class="text-xs opacity-75">á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±</div>
            <div class="font-bold text-lg" id="userBalance">0 á€€á€»á€•á€º</div>
          </div>
          <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 rounded-lg">ğŸšª</button>
        </div>
      </div>
    </div>
    <div class="text-center py-4">
      <h1 class="text-2xl font-bold text-gray-800 mb-1">ğŸ° Myanmar 2D Lottery</h1>
      <p class="text-gray-600">á€™á€¼á€”á€ºá€™á€¬ á‚á€œá€¯á€¶á€¸ á€‘á€® - á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€•á€«á€…á€±! ğŸ€ (Realtime)</p>
    </div>
  </div>

  <!-- Lottery Results -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-4 text-white text-center">
        <h2 class="text-2xl font-bold mb-1">ğŸ† á€šá€”á€±á€· á€‘á€®á€›á€œá€’á€ºá€™á€»á€¬á€¸</h2>
        <p class="opacity-90" id="currentDate">Loading...</p>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="bg-blue-50 rounded-lg p-4">
              <div class="text-lg font-bold text-blue-800 mb-2">ğŸŒ… á€™á€”á€€á€º 9:30</div>
              <div class="bg-white rounded-lg p-4 shadow-inner">
                <div id="result930" class="text-3xl font-bold text-gray-400">á€™á€‘á€½á€€á€ºá€á€±á€¸</div>
              </div>
            </div>
          </div>
          <div class="text-center">
            <div class="bg-green-50 rounded-lg p-4">
              <div class="text-lg font-bold text-green-800 mb-2">â˜€ï¸ á€”á€±á€·á€œá€Šá€º 2:00</div>
              <div class="bg-white rounded-lg p-4 shadow-inner">
                <div id="result200" class="text-3xl font-bold text-gray-400">á€™á€‘á€½á€€á€ºá€á€±á€¸</div>
              </div>
            </div>
          </div>
          <div class="text-center">
            <div class="bg-purple-50 rounded-lg p-4">
              <div class="text-lg font-bold text-purple-800 mb-2">ğŸŒ† á€Šá€”á€± 4:30</div>
              <div class="bg-white rounded-lg p-4 shadow-inner">
                <div id="result430" class="text-3xl font-bold text-gray-400">á€™á€‘á€½á€€á€ºá€á€±á€¸</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Area -->
  <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white text-center">
      <h2 class="text-2xl font-bold mb-2">ğŸ¯ á€‘á€®á€‘á€­á€¯á€¸á€›á€”á€º</h2>
      <p class="opacity-90">á€”á€¶á€•á€«á€á€ºá€”á€¾á€„á€·á€º á€„á€½á€±á€•á€™á€¬á€ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€«</p>
    </div>

    <div class="p-6">
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ« á€‘á€®á€‘á€­á€¯á€¸á€›á€”á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€•á€«</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">á€”á€¶á€•á€«á€á€º</label>
            <input type="text" id="numberInput" placeholder="á€¥á€•á€™á€¬: 23" maxlength="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-xl font-bold">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">á€„á€½á€±á€•á€™á€¬á€ (á€€á€»á€•á€º)</label>
            <input type="number" id="amountInput" placeholder="100" min="100" step="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-lg font-bold">
          </div>
          <div class="flex items-end">
            <button id="addBetBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">â• á€‘á€Šá€·á€ºá€™á€Šá€º</button>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ á€™á€„á€ºá€¸á€‘á€­á€¯á€¸á€‘á€¬á€¸á€á€±á€¬ á€‘á€®á€™á€»á€¬á€¸</h3>
        <div id="betList" class="space-y-3 min-h-[100px]">
          <div class="text-center text-gray-500 py-8"><p>á€‘á€®á€™á€‘á€­á€¯á€¸á€›á€á€±á€¸á€•á€«</p></div>
        </div>
      </div>

      <div class="bg-yellow-100 rounded-lg p-4 mb-6">
        <div class="flex justify-between items-center">
          <span class="text-lg font-bold text-gray-800">ğŸ’µ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</span>
          <span id="totalAmount" class="text-2xl font-bold text-green-600">0 á€€á€»á€•á€º</span>
        </div>
      </div>

      <button id="payNowBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-4 px-6 rounded-xl text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all" disabled>ğŸ¯ á€‘á€®á€‘á€­á€¯á€¸á€™á€Šá€º</button>
    </div>
  </div>

  <!-- Admin Modal (keeps your original layout but we'll populate dynamic lists) -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl max-w-3xl mx-4 overflow-hidden w-full">
      <div class="bg-gradient-to-r from-red-500 to-pink-500 p-4 text-white">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">ğŸ‘‘ MASTER ADMIN CONTROL CENTER</h3>
          <button id="closeAdmin" class="text-white text-xl">âœ•</button>
        </div>
      </div>

      <div class="p-6 max-h-[60vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Left: Results & Controls -->
        <div>
          <div class="bg-yellow-50 rounded-lg p-4 mb-4">
            <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ° á€‘á€®á€›á€œá€’á€º á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€™á€¾á€¯</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-sm font-medium text-blue-800 mb-2">á€™á€”á€€á€º 9:30</div>
                <input type="text" id="admin930" placeholder="00-99" maxlength="2" class="w-full px-3 py-2 border rounded-lg text-center">
                <button onclick="announceResult('09:30','admin930')" class="w-full mt-2 bg-blue-500 text-white py-1 rounded">Set</button>
              </div>
              <div>
                <div class="text-sm font-medium text-green-800 mb-2">á€”á€±á€·á€œá€Šá€º 2:00</div>
                <input type="text" id="admin200" placeholder="00-99" maxlength="2" class="w-full px-3 py-2 border rounded-lg text-center">
                <button onclick="announceResult('14:00','admin200')" class="w-full mt-2 bg-green-500 text-white py-1 rounded">Set</button>
              </div>
              <div>
                <div class="text-sm font-medium text-purple-800 mb-2">á€Šá€”á€± 4:30</div>
                <input type="text" id="admin430" placeholder="00-99" maxlength="2" class="w-full px-3 py-2 border rounded-lg text-center">
                <button onclick="announceResult('16:30','admin430')" class="w-full mt-2 bg-purple-500 text-white py-1 rounded">Set</button>
              </div>
            </div>
            <div class="text-center"><button onclick="clearAllResults()" class="bg-red-500 text-white py-2 px-4 rounded">Clear Results</button></div>
          </div>

          <div class="bg-white rounded-lg p-4">
            <h4 class="font-bold mb-2">ğŸ“Œ Pending Transactions</h4>
            <div id="txList" class="space-y-2 max-h-40 overflow-y-auto"></div>
          </div>
        </div>

        <!-- Right: Bets & Users -->
        <div>
          <div class="bg-white rounded-lg p-4 mb-4">
            <h4 class="font-bold mb-2">ğŸ§¾ Pending Bets</h4>
            <div id="adminBets" class="space-y-2 max-h-44 overflow-y-auto"></div>
          </div>

          <div class="bg-green-50 rounded-lg p-4">
            <h4 class="font-bold mb-2">ğŸ‘¥ Users</h4>
            <div id="adminUsers" class="space-y-2 max-h-44 overflow-y-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin FAB -->
  <div class="fixed bottom-6 right-6">
    <button id="adminBtn" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-full shadow-lg hidden">ğŸ‘‘</button>
  </div>
</div>

<script>
/*
  Realtime Firebase version of the lottery frontend.
  - Replace firebaseConfig with your project's config.
  - Simple "users" auth (phone + password) kept for parity with original app.
  - IMPORTANT: For production, use Firebase Auth + DB rules.
*/

/////////////////////
// CONFIG - replace
/////////////////////
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
// Payout multiplier (example): when admin marks bet as "win", payout = amount * PAYOUT_MULTIPLIER
const PAYOUT_MULTIPLIER = 70; // <-- adjust to your rule or let admin credit manually

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/////////////////////
// App state
/////////////////////
let currentUser = null;      // { id: uid, phone, name, balance, type }
let localPendingBets = [];   // used only for UI before server writes
let todayResults = {};       // realtime from DB

/////////////////////
// Utility
/////////////////////
function q(id){ return document.getElementById(id); }
function formatMoney(n){ return Number(n).toLocaleString() + ' á€€á€»á€•á€º'; }
function nowDateKey(){ return new Date().toISOString().split('T')[0]; }

/////////////////////
// Seed default users (if none exist)
/////////////////////
function seedUsersIfEmpty(){
  db.ref('users').once('value').then(snap => {
    if (!snap.exists()) {
      const u = {
        // store password in plain text here only for demo; DO NOT do this in production
        // keys are auto-generated
      };
      const usersRef = db.ref('users');
      const user1 = usersRef.push();
      user1.set({ phone: '09123456789', password: '123456', name: 'User 1', balance: 50000, type: 'user' });
      const admin = usersRef.push();
      admin.set({ phone: '09750397287', password: 'admin123', name: 'Admin', balance: 999999, type: 'admin' });
    }
  }).catch(console.error);
}

/////////////////////
// Listeners: realtime updates for results, bets, users, transactions
/////////////////////
function setupRealtimeListeners(){
  // Results for today
  const resultsRef = db.ref('results/' + nowDateKey());
  resultsRef.on('value', snap => {
    const val = snap.val() || {};
    todayResults = val;
    updateLotteryResults();
  });

  // Bets -> Admin view and if current user is player -> my bets
  const betsRef = db.ref('bets');
  betsRef.on('value', snap => {
    const data = snap.val() || {};
    refreshAdminBets(data);
    refreshMyBets(data);
  });

  // Users list (for admin)
  db.ref('users').on('value', snap => {
    const users = snap.val() || {};
    refreshAdminUsers(users);
    // if currentUser is logged in, refresh balance and details
    if (currentUser) {
      const updated = Object.entries(users).find(([k,v]) => v.phone === currentUser.phone);
      if (updated) {
        currentUser.id = updated[0];
        currentUser.name = updated[1].name;
        currentUser.balance = Number(updated[1].balance || 0);
        q('userDisplayName').textContent = currentUser.name;
        q('userDisplayPhone').textContent = currentUser.phone;
        q('userBalance').textContent = formatMoney(currentUser.balance);
      }
    }
  });

  // Transactions (pending)
  db.ref('transactions').on('value', snap => {
    const txs = snap.val() || {};
    refreshTxList(txs);
  });
}

/////////////////////
// UI refresh helpers
/////////////////////
function updateLotteryResults(){
  const mapping = {'09:30':'result930','14:00':'result200','16:30':'result430'};
  Object.entries(mapping).forEach(([time,id])=>{
    const el = q(id);
    if (!el) return;
    const num = (todayResults && todayResults[time]) ? String(todayResults[time]).padStart(2,'0') : null;
    if (num) {
      el.textContent = num + ' á€˜á€²á€•á€”á€º';
      el.className = 'text-3xl font-bold text-green-600';
    } else {
      el.textContent = 'á€™á€‘á€½á€€á€ºá€á€±á€¸';
      el.className = 'text-3xl font-bold text-gray-400';
    }
  });
}

function refreshAdminBets(betsObj){
  const container = q('adminBets');
  container.innerHTML = '';
  const list = [];
  for (let id in betsObj){
    const b = betsObj[id];
    list.push({ id, ...b });
  }
  // sort by createdAt desc
  list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  if (list.length===0){
    container.innerHTML = '<div class="text-sm text-gray-500">No bets yet</div>';
    return;
  }
  container.innerHTML = list.map(b => {
    const userPhone = b.userPhone || b.userId;
    return `
      <div class="border rounded p-2 bg-white flex justify-between items-center">
        <div>
          <div class="font-medium">${userPhone} â†’ ${String(b.number).padStart(2,'0')} (${Number(b.amount).toLocaleString()} á€€á€»á€•á€º)</div>
          <div class="text-xs text-gray-500">status: ${b.status || 'pending'}</div>
        </div>
        <div class="flex gap-2">
          ${b.status === 'pending' ? `<button onclick="adminSetBet('${b.id}','win')" class="px-2 py-1 bg-green-500 text-white rounded text-sm">Win</button>
          <button onclick="adminSetBet('${b.id}','lose')" class="px-2 py-1 bg-red-500 text-white rounded text-sm">Lose</button>` : ''}
          <button onclick="adminRemoveBet('${b.id}')" class="px-2 py-1 bg-gray-200 rounded text-sm">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

function refreshMyBets(betsObj){
  if (!currentUser) return;
  const list = [];
  for (let id in betsObj){
    const b = betsObj[id];
    if (b.userId === currentUser.id) {
      list.push({ id, ...b });
    }
  }
  // update betList UI (player view)
  const container = q('betList');
  if (list.length===0){
    container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>á€‘á€®á€™á€‘á€­á€¯á€¸á€›á€á€±á€¸á€•á€«</p></div>';
    q('totalAmount').textContent = '0 á€€á€»á€•á€º';
    q('payNowBtn').disabled = true;
    return;
  }
  // show each bet
  container.innerHTML = list.map(b => `
    <div class="bet-card bg-white border rounded-lg p-4 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div class="bg-blue-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">${String(b.number).padStart(2,'0')}</div>
        <div>
          <div class="font-bold text-gray-800">${Number(b.amount).toLocaleString()} á€€á€»á€•á€º</div>
          <div class="text-sm text-gray-600">status: ${b.status||'pending'}</div>
        </div>
      </div>
      <div class="text-sm text-gray-600">${b.createdAt ? new Date(b.createdAt).toLocaleTimeString() : ''}</div>
    </div>
  `).join('');
  // compute total of pending bets for this user (for UI only)
  const total = list.filter(x=>x.status==='pending').reduce((s,x)=> s + Number(x.amount), 0);
  q('totalAmount').textContent = Number(total).toLocaleString() + ' á€€á€»á€•á€º';
  q('payNowBtn').disabled = true; // in this Firebase flow, placing bet immediately pushes to DB and deducts balance; so disable payNowBtn
}

function refreshAdminUsers(usersObj){
  const container = q('adminUsers');
  container.innerHTML = '';
  const list = [];
  for (let id in usersObj){
    list.push({ id, ...usersObj[id] });
  }
  list.sort((a,b)=> (b.balance||0)-(a.balance||0));
  container.innerHTML = list.map(u => `
    <div class="border rounded p-2 bg-white flex justify-between items-center">
      <div>
        <div class="font-medium">${u.name || u.phone}</div>
        <div class="text-xs text-gray-500">${u.phone}</div>
      </div>
      <div class="text-right">
        <div class="text-sm text-gray-500">Balance</div>
        <div class="font-bold text-green-600">${Number(u.balance||0).toLocaleString()} á€€á€»á€•á€º</div>
      </div>
    </div>
  `).join('');
}

function refreshTxList(txsObj){
  const container = q('txList');
  container.innerHTML = '';
  const list = [];
  for (let id in txsObj){
    list.push({ id, ...txsObj[id] });
  }
  list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  if (list.length===0) { container.innerHTML = '<div class="text-sm text-gray-500">No transactions</div>'; return; }
  container.innerHTML = list.map(tx => `
    <div class="border rounded p-2 bg-white flex justify-between items-center">
      <div>
        <div class="font-medium">${tx.userPhone || tx.userId} â†’ ${tx.type} ${Number(tx.amount).toLocaleString()} á€€á€»á€•á€º</div>
        <div class="text-xs text-gray-500">${tx.status || 'pending'}</div>
      </div>
      <div class="flex gap-2">
        ${tx.status === 'pending' ? `<button onclick="adminApproveTx('${tx.id}')" class="px-2 py-1 bg-green-500 text-white rounded text-sm">Approve</button>
        <button onclick="adminRejectTx('${tx.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-sm">Reject</button>` : ''}
      </div>
    </div>
  `).join('');
}

/////////////////////
// Auth & Login (simple)
/////////////////////
function login(phone, password){
  // find user from DB (one-time read)
  return db.ref('users').orderByChild('phone').equalTo(phone).once('value').then(snap=>{
    if (!snap.exists()) return false;
    const users = snap.val();
    const key = Object.keys(users)[0];
    const user = users[key];
    if (user.password !== password) return false;
    currentUser = { id: key, phone: user.phone, name: user.name || user.phone, balance: Number(user.balance||0), type: user.type || 'user' };
    // show main app
    q('loginPhone').value = '';
    q('loginPassword').value = '';
    q('loginScreen').classList.add('hidden');
    q('mainApp').classList.remove('hidden');
    q('userDisplayName').textContent = currentUser.name;
    q('userDisplayPhone').textContent = currentUser.phone;
    q('userBalance').textContent = formatMoney(currentUser.balance);
    // show admin button if admin
    if (currentUser.type === 'admin') q('adminBtn').classList.remove('hidden');
    else q('adminBtn').classList.add('hidden');
    return true;
  }).catch(err=>{
    console.error(err);
    return false;
  });
}

function logout(){
  currentUser = null;
  q('mainApp').classList.add('hidden');
  q('loginScreen').classList.remove('hidden');
  q('adminBtn').classList.add('hidden');
}

/////////////////////
// Betting workflow
// We will: atomically check user.balance via transaction and create bet
/////////////////////
function placeBetFirebase(number, amount){
  if (!currentUser) { alert('á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€•á€«'); return; }
  number = String(parseInt(number)).padStart(2,'0');
  amount = Number(amount);
  if (!number || number.length !== 2 || isNaN(amount) || amount < 100) { alert('á€”á€¶á€•á€«á€á€º á‚ á€œá€¯á€¶á€¸ á€”á€¾á€„á€·á€º á€„á€½á€±á€•á€™á€¬á€á€™á€¾á€”á€ºá€¡á€±á€¬á€„á€ºá€‘á€Šá€·á€ºá€•á€«'); return; }

  const userBalanceRef = db.ref(`users/${currentUser.id}/balance`);
  // atomic transaction to subtract balance and push bet
  userBalanceRef.transaction(balance=>{
    balance = Number(balance||0);
    if (balance >= amount) {
      return balance - amount;
    } else {
      return; // abort transaction (not enough funds)
    }
  }, (err, committed, snapshot)=>{
    if (err) { alert('Server error'); console.error(err); return; }
    if (!committed) { alert('á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€± á€™á€œá€¯á€¶á€œá€±á€¬á€€á€ºá€•á€«'); return; }
    // record bet
    const betRef = db.ref('bets').push();
    betRef.set({
      userId: currentUser.id,
      userPhone: currentUser.phone,
      number,
      amount,
      status: 'pending',
      createdAt: Date.now()
    }).then(()=>{
      // update currentUser balance in UI
      currentUser.balance = Number(snapshot.val());
      q('userBalance').textContent = formatMoney(currentUser.balance);
      alert('á€‘á€®á€‘á€­á€¯á€¸á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º!');
    }).catch(e=>{ console.error(e); alert('Bet save error'); });
  });
}

/////////////////////
// Admin actions: set bet win/lose, approve tx, announce result
/////////////////////
function adminSetBet(betId, result){
  if (!currentUser || currentUser.type !== 'admin') { alert('Admin only'); return; }
  // update bet status
  const betRef = db.ref('bets/' + betId);
  betRef.once('value').then(snap=>{
    if (!snap.exists()) return alert('Bet not found');
    const bet = snap.val();
    if (result === 'win') {
      // pay out: compute payout
      const payout = Number(bet.amount) * PAYOUT_MULTIPLIER;
      // add payout to user balance with transaction
      const userBalanceRef = db.ref(`users/${bet.userId}/balance`);
      userBalanceRef.transaction(balance=>{
        return Number(balance||0) + payout;
      }, (err, committed, s2)=>{
        if (err) { console.error(err); alert('Error paying out'); return; }
        // update bet status
        betRef.update({ status: 'win', settledAt: Date.now(), adminId: currentUser.id });
        // record transaction
        const txRef = db.ref('transactions').push();
        txRef.set({
          userId: bet.userId,
          userPhone: bet.userPhone,
          type: 'payout',
          amount: payout,
          relatedBetId: betId,
          status: 'approved',
          createdAt: Date.now(),
          processedBy: currentUser.id
        });
        alert('Bet marked WIN and payout issued.');
      });
    } else if (result === 'lose') {
      betRef.update({ status: 'lose', settledAt: Date.now(), adminId: currentUser.id });
      alert('Bet marked LOSE.');
    }
  });
}

function adminRemoveBet(betId){
  if (!currentUser || currentUser.type !== 'admin') return alert('Admin only');
  if (!confirm('Delete this bet permanently?')) return;
  db.ref('bets/' + betId).remove();
}

function announceResult(time, inputId){
  if (!currentUser || currentUser.type !== 'admin') return alert('Admin only');
  const input = q(inputId);
  const number = input.value.trim();
  if (!number || number.length > 2 || isNaN(parseInt(number))) return alert('á€”á€¶á€•á€«á€á€º á‚ á€œá€¯á€¶á€¸á€‘á€Šá€·á€ºá€•á€«');
  const formatted = String(parseInt(number)).padStart(2,'0');
  const key = nowDateKey();
  const updates = {};
  updates[`results/${key}/${time}`] = formatted;
  db.ref().update(updates).then(()=>{
    input.value = '';
    alert('Result announced: ' + formatted);
  });
}

function clearAllResults(){
  if (!currentUser || currentUser.type !== 'admin') return alert('Admin only');
  if (!confirm('Clear all today results?')) return;
  db.ref('results/' + nowDateKey()).remove().then(()=> alert('Results cleared.'));
}

/////////////////////
// Transactions (users request deposit/withdraw)
/////////////////////
function requestTransaction(type, amount){
  if (!currentUser) return alert('Login required');
  const txRef = db.ref('transactions').push();
  txRef.set({
    userId: currentUser.id,
    userPhone: currentUser.phone,
    type: type, // deposit or withdraw
    amount: Number(amount),
    status: 'pending',
    createdAt: Date.now()
  }).then(()=> alert('Transaction requested. Admin will review.'));
}

function adminApproveTx(txId){
  if (!currentUser || currentUser.type !== 'admin') return;
  const txRef = db.ref('transactions/' + txId);
  txRef.once('value').then(snap=>{
    if (!snap.exists()) return;
    const tx = snap.val();
    if (tx.status !== 'pending') return alert('Already processed');
    const userBalRef = db.ref('users/' + tx.userId + '/balance');
    if (tx.type === 'deposit') {
      // add balance
      userBalRef.transaction(b => Number(b||0) + Number(tx.amount), (err, committed, s)=> {
        if (err) { console.error(err); return; }
        txRef.update({ status: 'approved', processedBy: currentUser.id, processedAt: Date.now() });
        alert('Deposit approved.');
      });
    } else if (tx.type === 'withdraw') {
      // subtract if enough
      userBalRef.transaction(b=>{
        b = Number(b||0);
        if (b >= Number(tx.amount)) return b - Number(tx.amount);
        return; // abort if insufficient
      }, (err, committed, s)=>{
        if (err) { console.error(err); return; }
        if (!committed) return alert('User has insufficient balance for withdrawal.');
        txRef.update({ status: 'approved', processedBy: currentUser.id, processedAt: Date.now() });
        alert('Withdrawal approved and balance deducted.');
      });
    }
  });
}

function adminRejectTx(txId){
  if (!currentUser || currentUser.type !== 'admin') return;
  db.ref('transactions/' + txId).update({ status: 'rejected', processedBy: currentUser.id, processedAt: Date.now() });
  alert('Transaction rejected.');
}

/////////////////////
// UI Events & startup
/////////////////////
q('loginBtn').addEventListener('click', ()=>{
  const phone = q('loginPhone').value.trim();
  const pass = q('loginPassword').value.trim();
  login(phone, pass).then(ok=>{
    if (!ok) alert('á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«');
  });
});

q('logoutBtn').addEventListener('click', ()=>{
  if (confirm('Logout?')) logout();
});

q('addBetBtn').addEventListener('click', ()=>{
  const num = q('numberInput').value.trim();
  const amt = q('amountInput').value.trim();
  placeBetFirebase(num, Number(amt));
  q('numberInput').value = '';
  q('amountInput').value = '';
});

q('adminBtn').addEventListener('click', ()=>{
  q('adminModal').classList.remove('hidden');
  q('adminModal').classList.add('flex');
});

q('closeAdmin').addEventListener('click', ()=>{
  q('adminModal').classList.add('hidden');
  q('adminModal').classList.remove('flex');
});

q('payNowBtn').addEventListener('click', ()=> {
  // kept for compatibility but placing bet is immediate in Firebase flow
  alert('This version instantly places bets when you add them (server-charged).');
});

// deposit/withdraw quick UI (not originally present) â€” you can call requestTransaction from console or add buttons
// Example usage: requestTransaction('deposit', 10000);

/////////////////////
// Initialize App
/////////////////////
function init(){
  seedUsersIfEmpty();
  setupRealtimeListeners();
  q('currentDate').textContent = new Date().toLocaleDateString('my-MM', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
}
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
